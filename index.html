<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>üîß Edytor Bazy WOS - Professional Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary: #1e3a8a;
      --primary-dark: #1e40af;
      --secondary: #059669;
      --danger: #dc2626;
      --warning: #d97706;
      --info: #0891b2;
      --success: #16a34a;
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --bg-tertiary: #f1f5f9;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

    header {
      background: var(--bg-primary);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: var(--shadow-lg);
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    header::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--secondary), var(--info));
    }

    h1 {
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }

    .subtitle { color: var(--text-secondary); font-size: 1.1rem; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--bg-primary);
      border-radius: 12px;
      padding: 24px;
      box-shadow: var(--shadow);
      text-align: center;
      transition: transform 0.2s, box-shadow 0.2s;
      border: 1px solid var(--border);
    }

    .stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    .stat-number { font-size: 2.5rem; font-weight: 700; color: var(--primary); margin-bottom: 8px; }
    .stat-label { color: var(--text-secondary); font-weight: 500; }

    .card {
      background: var(--bg-primary);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border);
    }

    .card-title { font-size: 1.25rem; font-weight: 600; color: var(--text-primary); }

    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary); }

    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: 14px;
      transition: border-color 0.2s, box-shadow 0.2s;
      background: var(--bg-primary);
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
    }

    button {
      padding: 12px 24px;
      margin: 8px 8px 8px 0;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); box-shadow: var(--shadow); }
    .btn-success { background: var(--success); color: white; }
    .btn-success:hover { background: #15803d; transform: translateY(-1px); box-shadow: var(--shadow); }
    .btn-danger { background: var(--danger); color: white; }
    .btn-danger:hover { background: #b91c1c; transform: translateY(-1px); box-shadow: var(--shadow); }
    .btn-info { background: var(--info); color: white; }
    .btn-info:hover { background: #0e7490; transform: translateY(-1px); box-shadow: var(--shadow); }
    .btn-secondary { background: var(--text-secondary); color: white; }
    .btn-secondary:hover { background: #475569; transform: translateY(-1px); box-shadow: var(--shadow); }

    .search-container {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 16px;
      align-items: end;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
      background: var(--bg-primary);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
    th { background: var(--bg-tertiary); font-weight: 600; color: var(--text-primary); position: sticky; top: 0; z-index: 10; }
    tr:hover { background: var(--bg-secondary); }

    .station-item {
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      transition: all 0.2s;
    }

    .station-item:hover { box-shadow: var(--shadow-lg); transform: translateY(-1px); }

    .station-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border);
    }

    .station-title { font-size: 1.25rem; font-weight: 600; color: var(--primary); }
    .station-actions { display: flex; gap: 8px; }

    pre {
      background: #1e293b;
      color: #e2e8f0;
      padding: 20px;
      border-radius: 8px;
      overflow: auto;
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      line-height: 1.5;
      margin-top: 20px;
      box-shadow: var(--shadow);
      max-height: 500px;
    }

    .notification {
      position: fixed;
      top: 20px; right: 20px;
      padding: 16px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      animation: slideIn 0.4s ease;
      max-width: 400px;
      transition: all 0.3s ease;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }

    .notification.success { background: var(--success); }
    .notification.error { background: var(--danger); }
    .notification.info { background: var(--info); }
    .notification.warning { background: var(--warning); }

    .loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      opacity: 0; visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .loading-overlay.active { opacity: 1; visibility: visible; }
    .loading-modal {
      background: var(--bg-primary); border-radius: 16px; padding: 40px;
      text-align: center; box-shadow: var(--shadow-lg); max-width: 400px; width: 90%;
    }
    .loading-spinner {
      width: 60px; height: 60px;
      border: 4px solid var(--border); border-radius: 50%; border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite; margin: 0 auto 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .auth-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex; justify-content: center; align-items: center;
      z-index: 10000;
      opacity: 1; visibility: visible;
      transition: opacity 0.5s, visibility 0.5s;
    }
    .auth-overlay.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
    .auth-modal {
      background: var(--bg-primary); border-radius: 20px; padding: 50px;
      text-align: center; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 450px; width: 90%; backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .auth-icon { font-size: 4rem; color: var(--primary); margin-bottom: 20px; }
    .auth-title { font-size: 2rem; font-weight: 700; color: var(--text-primary); margin-bottom: 10px; }
    .auth-subtitle { color: var(--text-secondary); margin-bottom: 30px; font-size: 1rem; }
    .pin-input {
      width: 100%; padding: 18px; font-size: 1.5rem; text-align: center;
      letter-spacing: 8px; border: 2px solid var(--border); border-radius: 12px;
      font-family: 'JetBrains Mono', monospace; margin-bottom: 25px;
      background: var(--bg-secondary); transition: all 0.3s;
    }
    .pin-input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(30, 58, 138, 0.1); transform: translateY(-2px); }
    .pin-input.error { border-color: var(--danger); animation: shake 0.5s; }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    .auth-button {
      width: 100%; padding: 16px; font-size: 1.1rem; font-weight: 600;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white; border: none; border-radius: 12px; cursor: pointer;
      transition: all 0.3s; box-shadow: 0 4px 15px rgba(30, 58, 138, 0.3);
    }
    .auth-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(30, 58, 138, 0.4); }
    .error-message { color: var(--danger); font-size: 0.9rem; margin-top: 10px; opacity: 0; transition: opacity 0.3s; }
    .error-message.show { opacity: 1; }
    .fade-in { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    @media (max-width: 768px) {
      .container { padding: 12px; }
      h1 { font-size: 2rem; }
      .search-container { grid-template-columns: 1fr; }
      .station-header { flex-direction: column; gap: 12px; align-items: flex-start; }
      .station-actions { width: 100%; justify-content: flex-start; }
      table { font-size: 12px; }
      th, td { padding: 8px; }
    }
  </style>
</head>
<body>
  <div class="auth-overlay" id="auth-overlay">
    <div class="auth-modal">
      <div class="auth-icon"><i class="fas fa-lock"></i></div>
      <h2 class="auth-title">Wymagana autoryzacja</h2>
      <p class="auth-subtitle">Wprowad≈∫ kod PIN</p>
      <input type="password" id="pin-input" class="pin-input" placeholder="********" maxlength="8" autocomplete="off">
      <button class="auth-button" onclick="checkPIN()">
        <i class="fas fa-unlock"></i> Odblokuj dostƒôp
      </button>
      <div class="error-message" id="error-message">Nieprawid≈Çowy kod PIN. Spr√≥buj ponownie.</div>
    </div>
  </div>

  <div class="loading-overlay" id="loading-overlay">
    <div class="loading-modal">
      <div class="loading-spinner"></div>
      <div class="loading-text">Wczytywanie bazy danych</div>
      <div class="loading-subtext">Proszƒô czekaƒá...</div>
    </div>
  </div>

  <div class="container">
    <header>
      <h1>üîß Edytor Bazy WOS</h1>
      <p class="subtitle">Professional Edition - ZarzƒÖdzanie ostrze≈ºeniami sta≈Çymi</p>
    </header>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="total-stations">0</div>
        <div class="stat-label">Stacji</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="total-warnings">0</div>
        <div class="stat-label">Ostrze≈ºe≈Ñ</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="last-update">‚Äî</div>
        <div class="stat-label">Ostatnia aktualizacja</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2 class="card-title">üîç Wyszukiwanie stacji</h2>
      </div>
      <div class="search-container">
        <div class="form-group">
          <label>Inteligentne wyszukiwanie:</label>
          <input list="stations-list" id="station-search" placeholder="Wpisz 2+ litery..." autocomplete="off">
          <datalist id="stations-list"></datalist>
        </div>
        <div class="form-group">
          <label>Lub wybierz z listy:</label>
          <select id="station-select">
            <option value="">‚Äî wybierz stacjƒô ‚Äî</option>
          </select>
        </div>
        <button class="btn-info" onclick="loadSelectedStation()">
          <i class="fas fa-edit"></i> Edytuj stacjƒô
        </button>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2 class="card-title">‚ûï Dodawanie nowej stacji</h2>
      </div>
      <div class="form-group">
        <label>Nazwa stacji:</label>
        <input type="text" id="add-name" placeholder="np. Nowa Stacja" autocomplete="off">
      </div>
      <table id="add-table">
        <thead>
          <tr>
            <th>Nazwa szlaku lub posterunku</th><th>od km</th><th>do km</th><th>Przyczyna</th><th>Nr toru</th>
            <th>Vmax nieparzystym</th><th>Vmax parzystym</th><th>Uwagi</th><th>Akcje</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div style="margin-top: 16px;">
        <button class="btn-secondary" onclick="addRow('add-table')">
          <i class="fas fa-plus"></i> Dodaj wiersz
        </button>
        <button class="btn-success" onclick="saveNewStation()">
          <i class="fas fa-save"></i> Zapisz stacjƒô
        </button>
      </div>
    </div>

    <div id="station-list"></div>

    <div class="card">
      <div class="card-header">
        <h2 class="card-title">üìÑ Generowanie pliku baza.js</h2>
      </div>
      <div style="margin-bottom: 16px;">
        <button class="btn-info" onclick="generateCode()">
          <i class="fas fa-code"></i> Generuj kod
        </button>
        <button class="btn-success" onclick="downloadCode()">
          <i class="fas fa-download"></i> Pobierz plik
        </button>
        <button class="btn-secondary" onclick="copyToClipboard()">
          <i class="fas fa-copy"></i> Kopiuj do schowka
        </button>
      </div>
      <pre id="generated">Kliknij "Generuj kod" aby wygenerowaƒá plik baza.js</pre>
    </div>
  </div>

  <script>
    const PIN_HASH = 'MjEzNzIxMzc='; // 21372137
    // DEFINICJA KLUCZY DLA BAZY - W KOLEJNO≈öCI KOLUMN
    const ROW_KEYS = ['stacja', 'odkm', 'dokm', 'przyczyna', 'tor', 'vniep', 'vparz', 'uwagi'];

    function decodePIN(encoded) {
      try { return atob(encoded); } catch (e) { return null; }
    }

    function checkPIN() {
      const input = document.getElementById('pin-input');
      const errorMsg = document.getElementById('error-message');
      
      const enteredPIN = input.value;
      const correctPIN = decodePIN(PIN_HASH);
      
      if (enteredPIN === correctPIN) {
        document.getElementById('auth-overlay').classList.add('hidden');
        input.classList.remove('error');
        errorMsg.classList.remove('show');
        
        setTimeout(() => { initializeApp(); }, 500);
      } else {
        input.classList.add('error');
        errorMsg.classList.add('show');
        input.value = '';
        input.focus();
        setTimeout(() => { input.classList.remove('error'); }, 500);
      }
    }
    
    function checkAuthStatus() {
      document.getElementById('auth-overlay').classList.remove('hidden');
      document.getElementById('pin-input').focus();
    }
    
    function initializeApp() {
      loadBaza();
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      checkAuthStatus();
      
      const pinInput = document.getElementById('pin-input');
      if (pinInput) {
        pinInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') checkPIN();
        });
        pinInput.focus();
      }
      
      document.getElementById('station-search').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') loadSelectedStation();
      });
      
      document.getElementById('add-name').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') addRow('add-table');
      });
      
      setInterval(updateStats, 60000);
    });

    let baza = {};
    let isLoading = false;
    let notificationCounter = 0;
    
    function showNotification(message, type = 'info', duration = 4000) {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.style.top = `${20 + (notificationCounter * 70)}px`;
      notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
      document.body.appendChild(notification);
      notificationCounter++;

      setTimeout(() => {
        notification.style.animation = 'slideOut 0.4s ease forwards';
        setTimeout(() => {
          notification.remove();
          notificationCounter--;
          document.querySelectorAll('.notification').forEach((notif, index) => {
            notif.style.transition = 'top 0.3s ease';
            notif.style.top = `${20 + (index * 70)}px`;
          });
        }, 400);
      }, duration);
    }

    function updateStats() {
      const stationsCount = Object.keys(baza).length;
      let warningsCount = 0;
      Object.values(baza).forEach(warnings => { warningsCount += warnings.length; });

      document.getElementById('total-stations').textContent = stationsCount;
      document.getElementById('total-warnings').textContent = warningsCount;
      document.getElementById('last-update').textContent = new Date().toLocaleTimeString('pl-PL');
    }

    function validateStationData(name, rows) {
      if (!name || name.trim().length < 2) throw new Error('Nazwa stacji musi mieƒá co najmniej 2 znaki');
      if (!rows || rows.length === 0) throw new Error('Stacja musi mieƒá co najmniej jeden wiersz');
      
      rows.forEach((row, index) => {
        // Walidacja odkm i dokm
        const odkm = row['odkm'];
        const dokm = row['dokm'];
        
        [odkm, dokm].forEach(kmValue => {
            if (kmValue && kmValue.trim()) {
                const formatted = kmValue.replace('.', ',');
                if (!/^\d+(,\d+)?$/.test(formatted)) {
                   // Tutaj mo≈ºna dodaƒá strict validation je≈õli potrzeba
                }
            }
        });
      });
    }

    async function loadBaza() {
      if (isLoading) return;
      isLoading = true;
      const overlay = document.getElementById('loading-overlay');
      overlay.classList.add('active');

      try {
        const url = 'https://raw.githubusercontent.com/niebieskawy/wos.td2.editor/main/baza.js';
        const res = await fetch(url);
        
        let text;
        if (res.ok) {
           text = await res.text();
        } else {
           console.warn('Nie uda≈Ço siƒô pobraƒá bazy (CORS?), startujƒô z pustƒÖ.');
           text = "export default {}";
        }
        
        text = text.trim().replace(/^\uFEFF/, '');
        
        const start = text.indexOf('{');
        if (start === -1) throw new Error('Nie znaleziono poczƒÖtku obiektu');
        
        let count = 1;
        let end = start + 1;
        while (end < text.length && count > 0) {
          if (text[end] === '{') count++;
          if (text[end] === '}') count--;
          end++;
        }
        
        if (count !== 0) throw new Error('Niezbalansowane klamry');
        
        const jsonStr = text.substring(start, end);
        const parser = new Function('return ' + jsonStr);
        baza = parser();
        
        populateSelects();
        updateStats();
        showNotification(`Gotowe! Wczytano stacji: ${Object.keys(baza).length}`, 'success');
        
      } catch (err) {
        console.error('B≈ÇƒÖd wczytywania:', err);
        showNotification(`B≈ÇƒÖd wczytywania: ${err.message}. Utworzono pustƒÖ bazƒô.`, 'warning');
        baza = {};
        updateStats();
      } finally {
        isLoading = false;
        overlay.classList.remove('active');
      }
    }

    function populateSelects() {
      const select = document.getElementById('station-select');
      const datalist = document.getElementById('stations-list');
      
      select.innerHTML = '<option value="">‚Äî wybierz stacjƒô ‚Äî</option>';
      datalist.innerHTML = '';
      
      Object.keys(baza).sort((a, b) => a.localeCompare(b, 'pl')).forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt.cloneNode(true));
        datalist.appendChild(opt);
      });
    }

    function loadSelectedStation() {
      const name = document.getElementById('station-search').value.trim() || 
                   document.getElementById('station-select').value.trim();
      
      if (!name) {
        showNotification('Wybierz stacjƒô do edycji', 'warning');
        return;
      }
      
      if (!baza[name]) {
        showNotification('Stacja nie istnieje w bazie', 'error');
        return;
      }
      
      const safeId = name.replace(/[^a-zA-Z0-9]/g, '-');
      let section = document.getElementById(`edit-${safeId}`);
      
      if (section) section.remove();
      
      section = document.createElement('div');
      section.id = `edit-${safeId}`;
      section.className = 'station-item fade-in';
      section.innerHTML = `
        <div class="station-header">
          <h3 class="station-title" id="station-title-${safeId}">üìç ${name}</h3>
          <div class="station-name-edit" style="display: none;">
            <input type="text" id="edit-name-${safeId}" value="${name}" class="form-control">
          </div>
          <div class="station-actions">
            <button class="btn-secondary" id="toggle-edit-btn-${safeId}" onclick="toggleStationNameEdit('${name.replace(/'/g, "\\'")}', '${safeId}')">
              <i class="fas fa-edit"></i> Zmie≈Ñ nazwƒô
            </button>
            <button class="btn-success" onclick="saveEdit('${name.replace(/'/g, "\\'")}', '${safeId}')">
              <i class="fas fa-save"></i> Zapisz
            </button>
            <button class="btn-danger" onclick="deleteStation('${name.replace(/'/g, "\\'")}')">
              <i class="fas fa-trash"></i> Usu≈Ñ
            </button>
          </div>
        </div>
        <table id="edit-table-${safeId}" data-name="${name}">
          <thead>
            <tr>
              <th>Nazwa szlaku lub posterunku</th><th>od km</th><th>do km</th><th>Przyczyna</th><th>Nr toru</th>
              <th>Vmax nieparzystym</th><th>Vmax parzystym</th><th>Uwagi</th><th>Akcje</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button class="btn-secondary" onclick="addRow('edit-table-${safeId}')">
          <i class="fas fa-plus"></i> Dodaj wiersz
        </button>
      `;
      document.getElementById('station-list').prepend(section);
      
      const tbody = section.querySelector('tbody');
      
      tbody.innerHTML = baza[name].map((row, idx) => `
        <tr>
          <td><input value="${row['stacja']||''}" placeholder="szlak/stacja"></td>
          <td><input value="${row['odkm']||''}" placeholder="od km"></td>
          <td><input value="${row['dokm']||''}" placeholder="do km"></td>
          <td><input value="${row['przyczyna']||''}" placeholder="przyczyna"></td>
          <td><input value="${row['tor']||''}" placeholder="tor"></td>
          <td><input value="${row['vniep']||''}" placeholder="Vmax nieparzystym"></td>
          <td><input value="${row['vparz']||''}" placeholder="Vmax parzystym"></td>
          <td><input value="${row['uwagi']||''}" placeholder="uwagi"></td>
          <td>
            <button class="btn-danger" onclick="deleteRow('${name.replace(/'/g, "\\'")}', ${idx}, this)">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `).join('');
      
      section.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function addRow(tableId) {
      const tbody = document.getElementById(tableId).querySelector('tbody');
      const row = tbody.insertRow();
      row.className = 'fade-in';
      
      const placeholders = ['stacjaSzlak', 'od km', 'do km', 'przyczyna', 'tor', 'Vmax nieparzystym', 'Vmax parzystym', 'uwagi'];
      placeholders.forEach((placeholder) => {
        const cell = row.insertCell();
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = placeholder;
        cell.appendChild(input);
      });
      
      const actionCell = row.insertCell();
      actionCell.innerHTML = `
        <button class="btn-danger" onclick="this.closest('tr').remove()">
          <i class="fas fa-trash"></i>
        </button>
      `;
    }

    // Funkcja pomocnicza do pobierania danych z wiersza jako obiekt
    function getRowData(tr) {
        const inputs = Array.from(tr.querySelectorAll('input'));
        const obj = {};
        inputs.forEach((input, index) => {
            // Mapowanie indeksu inputa na klucz obiektu
            if (ROW_KEYS[index]) {
                obj[ROW_KEYS[index]] = input.value.trim();
            }
        });
        return obj;
    }

    // Funkcja pomocnicza do pobierania wszystkich wierszy z tabeli jako tablica obiekt√≥w
    function getTableData(tableElement) {
        const tbody = tableElement.querySelector('tbody');
        return Array.from(tbody.rows).map(row => getRowData(row));
    }

    function saveNewStation() {
      try {
        const name = document.getElementById('add-name').value.trim();
        const table = document.getElementById('add-table');
        const rows = getTableData(table); // Zwraca tablicƒô obiekt√≥w z kluczami

        validateStationData(name, rows);

        if (baza[name]) {
          if (!confirm(`Stacja "${name}" ju≈º istnieje. Nadpisaƒá?`)) return;
        }

        baza[name] = rows;
        populateSelects();
        updateStats();
        
        document.getElementById('add-name').value = '';
        table.querySelector('tbody').innerHTML = '';
        
        showNotification(`Stacja "${name}" zosta≈Ça zapisana`, 'success');
        
      } catch (error) {
        showNotification(error.message, 'error');
      }
    }

    function deleteRow(name, idx, btn) {
      if (!confirm('UsunƒÖƒá ten wiersz?')) return;
      
      const tableId = btn.closest('table').id;
      const row = btn.closest('tr');
      row.remove();
      
      // Aktualizacja bazy z zachowaniem struktury kluczy
      const table = document.getElementById(tableId);
      const rows = getTableData(table);
      
      baza[name] = rows;
      
      updateStats();
      showNotification('Wiersz usuniƒôty (pamiƒôtaj o zapisaniu zmian przy edycji)', 'info');
    }

    function deleteStation(name) {
      if (!confirm(`Czy na pewno usunƒÖƒá stacjƒô "${name}"?`)) return;
      
      delete baza[name];
      
      const safeId = name.replace(/[^a-zA-Z0-9]/g, '-');
      const section = document.getElementById(`edit-${safeId}`);
      if (section) {
        section.style.animation = 'fadeIn 0.3s ease reverse';
        setTimeout(() => section.remove(), 300);
      }
      
      populateSelects();
      updateStats();
      showNotification(`Stacja "${name}" zosta≈Ça usuniƒôta`, 'success');
    }

    function toggleStationNameEdit(name, safeId) {
      const titleElement = document.getElementById(`station-title-${safeId}`);
      const editContainer = document.querySelector(`#edit-${safeId} .station-name-edit`);
      const toggleBtn = document.getElementById(`toggle-edit-btn-${safeId}`);
      
      if (editContainer.style.display === 'none' || editContainer.style.display === '') {
        titleElement.style.display = 'none';
        editContainer.style.display = 'block';
        toggleBtn.innerHTML = '<i class="fas fa-times"></i> Anuluj';
      } else {
        titleElement.style.display = 'block';
        editContainer.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fas fa-edit"></i> Zmie≈Ñ nazwƒô';
      }
    }

    function saveEdit(oldName, safeId) {
      try {
        const nameInput = document.getElementById(`edit-name-${safeId}`);
        const newName = nameInput.value.trim();
        
        const table = document.getElementById(`edit-table-${safeId}`);
        const rows = getTableData(table); // Zwraca tablicƒô obiekt√≥w z kluczami
        
        validateStationData(newName, rows);
        
        if (newName !== oldName) {
            if (baza[newName] && !confirm(`Stacja o nazwie "${newName}" ju≈º istnieje. Czy chcesz jƒÖ nadpisaƒá?`)) {
                return;
            }
            delete baza[oldName];
        }
        
        baza[newName] = rows;
        
        showNotification('Zmiany zapisane pomy≈õlnie!', 'success');
        updateStats();
        populateSelects();
        
        loadSelectedStation();
        document.getElementById('station-search').value = newName;
        
      } catch (e) {
        showNotification('B≈ÇƒÖd zapisu: ' + e.message, 'error');
        console.error(e);
      }
    }

    function generateCode() {
      // Sortowanie kluczy dla porzƒÖdku
      const sortedKeys = Object.keys(baza).sort((a, b) => a.localeCompare(b, 'pl'));
      const sortedBaza = {};
      sortedKeys.forEach(k => sortedBaza[k] = baza[k]);
      
      // JSON.stringify automatycznie uwzglƒôdni klucze (stacja, odkm, etc.)
      const jsonContent = JSON.stringify(sortedBaza, null, 2);
      
      const finalCode = `const BAZA_OSTRZEZEN = ${jsonContent};\n\nexport default BAZA_OSTRZEZEN;`;
      
      document.getElementById('generated').textContent = finalCode;
      showNotification('Kod wygenerowany!', 'success');
    }

    function downloadCode() {
      const content = document.getElementById('generated').textContent;
      if (content.startsWith('Kliknij')) {
         generateCode();
      }
      const finalContent = document.getElementById('generated').textContent;
      
      const blob = new Blob([finalContent], { type: 'text/javascript' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'baza.js';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function copyToClipboard() {
      const content = document.getElementById('generated').textContent;
      if (content.startsWith('Kliknij')) {
         showNotification('Najpierw wygeneruj kod!', 'warning');
         return;
      }
      
      navigator.clipboard.writeText(content).then(() => {
        showNotification('Skopiowano do schowka!', 'success');
      }).catch(err => {
        showNotification('B≈ÇƒÖd kopiowania', 'error');
      });
    }
  </script>
</body>
</html>
