<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Edytor bazy WOS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    font-family: system-ui, -apple-system, sans-serif;
    max-width: 1200px;
    margin: 32px auto;
    padding: 0 16px;
    background: #f8f9fa;
    color: #111;
  }
  h1 { color: #1a3c6d; margin-bottom: 24px; }
  h2 { color: #2c5282; }
  .field { margin: 16px 0; }
  label { display: block; margin-bottom: 6px; font-weight: 600; color: #333; }
  input, textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-family: monospace;
    font-size: 15px;
    box-sizing: border-box;
  }
  textarea { min-height: 120px; resize: vertical; }
  button {
    padding: 10px 20px;
    margin: 8px 8px 8px 0;
    background: #1a3c6d;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
  }
  button:hover { background: #254e8c; }
  button.danger { background: #dc3545; }
  button.danger:hover { background: #c82333; }
  table {
    width: 100%;
    border-collapse: collapse;
    margin: 16px 0;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: left;
  }
  th { background: #e3ebf5; font-weight: bold; }
  .station {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 24px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  .station-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }
  .station-actions button {
    margin-left: 8px;
  }
  pre#generated {
    background: #1e1e1e;
    color: #e0e0e0;
    padding: 16px;
    border-radius: 6px;
    overflow: auto;
    font-size: 14px;
    white-space: pre-wrap;
    word-break: break-all;
    margin-top: 24px;
  }
</style>
</head>
<body>

<h1>Edytor bazy WOS</h1>

<div id="stations-container"></div>

<button onclick="generateFullCode()">Generuj cały zaktualizowany kod baza.js</button>

<pre id="generated">// kliknij przycisk aby wygenerować</pre>

<script>
// Globalna baza – będzie nadpisywana po załadowaniu
let baza = {};

// 1. Ładowanie bazy z pliku baza.js
async function loadBaza() {
  try {
    const response = await fetch('./baza.js');
    if (!response.ok) throw new Error('Nie można wczytać baza.js');
    const text = await response.text();

    // Wyciągamy obiekt po export const BAZA_OSTRZEZEN =
    const match = text.match(/export\s+const\s+BAZA_OSTRZEZEN\s*=\s*({[\s\S]*?});/);
    if (!match) throw new Error('Nie znaleziono poprawnego eksportu');

    // Bezpieczne parsowanie
    baza = new Function(`return ${match[1]}`)();
    renderAllStations();
  } catch (err) {
    console.error('Błąd ładowania bazy:', err);
    document.getElementById('stations-container').innerHTML = 
      `<p style="color:red; font-weight:bold;">Błąd wczytywania baza.js: ${err.message}</p>`;
  }
}

// 2. Renderowanie wszystkich stacji
function renderAllStations() {
  const container = document.getElementById('stations-container');
  container.innerHTML = '';

  Object.keys(baza).sort().forEach(name => {
    const rows = baza[name];
    const section = document.createElement('div');
    section.className = 'station';
    section.innerHTML = `
      <div class="station-header">
        <h2>${name} (${rows.length} ostrzeżeń)</h2>
        <div class="station-actions">
          <button onclick="editStation('${name.replace(/'/g, "\\'")}')">Edytuj</button>
          <button class="danger" onclick="deleteStation('${name.replace(/'/g, "\\'")}')">Usuń</button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>od km</th>
            <th>do km</th>
            <th>Przyczyna</th>
            <th>Nr toru</th>
            <th>Vmax nieparz.</th>
            <th>Vmax parz.</th>
            <th>Uwagi</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(row => `
            <tr>
              <td>${row[0] ?? ''}</td>
              <td>${row[1] ?? ''}</td>
              <td>${row[2] ?? ''}</td>
              <td>${row[3] ?? ''}</td>
              <td>${row[4] ?? ''}</td>
              <td>${row[5] ?? ''}</td>
              <td>${row[6] ?? ''}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
    container.appendChild(section);
  });
}

// 3. Usuwanie całej stacji
function deleteStation(name) {
  if (!confirm(`Na pewno usunąć stację "${name}"?`)) return;
  delete baza[name];
  renderAllStations();
}

// 4. Edycja stacji (prosta – prompt z JSON)
function editStation(name) {
  const current = baza[name];
  const json = JSON.stringify(current, null, 2);
  const newJson = prompt(`Edytuj wiersze stacji "${name}" (JSON tablica tablic):`, json);
  if (!newJson) return;

  try {
    const parsed = JSON.parse(newJson);
    if (!Array.isArray(parsed)) throw new Error();
    baza[name] = parsed;
    renderAllStations();
  } catch {
    alert("Błędny format JSON!");
  }
}

// 5. Dodawanie nowej stacji
function addNewStation() {
  const name = prompt("Nazwa nowej stacji:");
  if (!name || baza[name]) {
    if (name) alert("Stacja już istnieje!");
    return;
  }

  const json = prompt("Wklej wiersze w formacie JSON tablicy tablic:", '[\n  ["","","","","","",""]\n]');
  if (!json) return;

  try {
    const parsed = JSON.parse(json);
    if (!Array.isArray(parsed)) throw new Error();
    baza[name] = parsed;
    renderAllStations();
  } catch {
    alert("Błędny format JSON!");
  }
}

// 6. Generowanie całego kodu
function generateFullCode() {
  let code = 'export const BAZA_OSTRZEZEN = {\n';
  Object.keys(baza).sort().forEach((key, i, arr) => {
    const json = JSON.stringify(baza[key], null, 2)
      .replace(/^(\[)/gm, '$1\n  ')
      .replace(/(\])$/, '\n$1');
    code += `  "${key.replace(/"/g, '\\"')}": ${json}${i < arr.length - 1 ? ',' : ''}\n`;
  });
  code += '};\n';

  document.getElementById('code-output').textContent = code;
}

// Start
document.addEventListener('DOMContentLoaded', loadBaza);
</script>

<!-- Przycisk dodawania nowej stacji -->
<div style="position: fixed; bottom: 24px; right: 24px;">
  <button onclick="addNewStation()">+ Nowa stacja</button>
</div>

</body>
</html>
