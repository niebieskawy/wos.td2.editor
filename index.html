<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Edytor bazy WOS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    font-family: system-ui, sans-serif;
    max-width: 1200px;
    margin: 32px auto;
    padding: 0 16px;
    background: #f8f9fa;
    color: #111;
  }
  h1, h2 { color: #1a3c6d; }
  .field { margin: 16px 0; }
  label { display: block; margin-bottom: 6px; font-weight: 600; color: #333; }
  input, textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-family: monospace;
    font-size: 15px;
    box-sizing: border-box;
  }
  textarea { min-height: 140px; resize: vertical; }
  button {
    padding: 10px 20px;
    margin: 8px 8px 8px 0;
    background: #1a3c6d;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
  }
  button:hover { background: #254e8c; }
  button.danger { background: #dc3545; }
  button.danger:hover { background: #c82333; }
  pre {
    background: #1e1e1e;
    color: #e0e0e0;
    padding: 16px;
    border-radius: 6px;
    overflow: auto;
    font-size: 14px;
    white-space: pre-wrap;
    word-break: break-all;
    margin-top: 16px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin: 16px 0;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: left;
  }
  th { background: #e3ebf5; font-weight: bold; }
  .station-list {
    margin: 24px 0;
  }
  .station-item {
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 12px;
  }
  .station-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }
  .station-actions button {
    margin-left: 8px;
  }
</style>
</head>
<body>

<h1>Edytor bazy WOS</h1>
<p>Edytuj, dodawaj i usuwaj stacje. Na końcu skopiuj cały zaktualizowany kod.</p>

<!-- Dodawanie nowej stacji -->
<h2>Dodaj nową stację</h2>
<div class="field">
  <label>Nazwa stacji / posterunku:</label>
  <input type="text" id="nowa-nazwa" placeholder="np. Nowa Stacja" required>
</div>

<div class="field">
  <label>Wpisz wiersze ostrzeżeń (format tablicy tablic):</label>
  <textarea id="nowe-wiersze" rows="10" placeholder='[
  ["0.123", "0.456", "zły stan toru", "1", "40", "40", "* ) doraźne"],
  ["1.789", "", "ograniczona widoczność", "2", "60", "-", "Nowe!"]
]'></textarea>
</div>

<button onclick="dodajNowaStacje()">Dodaj nową stację</button>

<!-- Lista wszystkich stacji -->
<h2>Aktualna baza (edytowalna)</h2>
<div class="station-list" id="lista-stacji"></div>

<!-- Przycisk generujący cały kod -->
<button onclick="generujCalaBaze()">Wygeneruj cały zaktualizowany kod baza.js</button>

<h3>Wygenerowany kod (kopiuj i wklej zamiast starego baza.js):</h3>
<pre id="wynik-kodu">// kliknij przycisk aby wygenerować</pre>

<script>
// Ładowanie bazy z pliku baza.js (zakładamy, że jest w tym samym folderze)
let baza = {};

async function zaladujBaze() {
  try {
    const response = await fetch('./baza.js');
    const text = await response.text();

    // Proste parsowanie – szukamy export const BAZA_OSTRZEZEN = { ... };
    const match = text.match(/export\s+const\s+BAZA_OSTRZEZEN\s*=\s*({[\s\S]*?});/);
    if (match && match[1]) {
      try {
        baza = eval(`(${match[1]})`); // niebezpieczne, ale dla lokalnego pliku ok
        wyswietlListeStacji();
      } catch (e) {
        alert("Błąd parsowania bazy! Sprawdź składnię w baza.js");
        console.error(e);
      }
    } else {
      alert("Nie znaleziono poprawnego eksportu BAZA_OSTRZEZEN w pliku baza.js");
    }
  } catch (err) {
    alert("Nie udało się wczytać pliku baza.js\n\n" + err.message);
    console.error(err);
  }
}

function wyswietlListeStacji() {
  const kontener = document.getElementById('lista-stacji');
  kontener.innerHTML = '';

  Object.keys(baza).sort().forEach(nazwa => {
    const wiersze = baza[nazwa];

    const div = document.createElement('div');
    div.className = 'station-item';
    div.innerHTML = `
      <div class="station-header">
        <strong>${nazwa} (${wiersze.length} wierszy)</strong>
        <div class="station-actions">
          <button onclick="edytujStacje('${nazwa.replace(/'/g, "\\'")}')">Edytuj</button>
          <button class="danger" onclick="usunStacje('${nazwa.replace(/'/g, "\\'")}')">Usuń</button>
        </div>
      </div>
      <pre>${JSON.stringify(wiersze, null, 2)}</pre>
    `;
    kontener.appendChild(div);
  });
}

function dodajNowaStacje() {
  const nazwa = document.getElementById('nowa-nazwa').value.trim();
  const raw = document.getElementById('nowe-wiersze').value.trim();

  if (!nazwa || !raw) {
    alert("Podaj nazwę i wiersze!");
    return;
  }

  let noweWiersze;
  try {
    noweWiersze = JSON.parse(raw);
    if (!Array.isArray(noweWiersze)) throw new Error();
  } catch {
    alert("Nieprawidłowy format JSON!");
    return;
  }

  if (baza[nazwa]) {
    if (!confirm(`Stacja "${nazwa}" już istnieje. Nadpisać?`)) return;
  }

  baza[nazwa] = noweWiersze;

  document.getElementById('nowa-nazwa').value = '';
  document.getElementById('nowe-wiersze').value = '';

  wyswietlListeStacji();
}

function usunStacje(nazwa) {
  if (!confirm(`Na pewno usunąć stację "${nazwa}"?`)) return;
  delete baza[nazwa];
  wyswietlListeStacji();
}

function edytujStacje(nazwa) {
  const obecne = baza[nazwa];
  const json = JSON.stringify(obecne, null, 2);

  const nowaNazwa = prompt("Nowa nazwa stacji (lub ta sama):", nazwa);
  if (!nowaNazwa) return;

  const noweWierszeRaw = prompt("Edytuj wiersze (JSON):", json);
  if (!noweWierszeRaw) return;

  let noweWiersze;
  try {
    noweWiersze = JSON.parse(noweWierszeRaw);
    if (!Array.isArray(noweWiersze)) throw new Error();
  } catch {
    alert("Błędny format JSON!");
    return;
  }

  if (nowaNazwa !== nazwa && baza[nowaNazwa]) {
    if (!confirm(`Stacja "${nowaNazwa}" już istnieje. Nadpisać?`)) return;
  }

  delete baza[nazwa];
  baza[nowaNazwa] = noweWiersze;

  wyswietlListeStacji();
}

function generujKodDlaWszystkich() {
  let kod = 'export const BAZA_OSTRZEZEN = {\n';
  Object.keys(baza).sort().forEach((nazwa, i) => {
    const json = JSON.stringify(baza[nazwa], null, 2)
      .replace(/^\[\n/g, '[\n  ')
      .replace(/\n\]$/g, '\n]');
    kod += `  "${nazwa.replace(/"/g, '\\"')}": ${json}${i < Object.keys(baza).length - 1 ? ',' : ''}\n`;
  });
  kod += '};';

  document.getElementById('wynik-kodu').textContent = kod;
}

// Ładujemy bazę przy starcie
document.addEventListener('DOMContentLoaded', zaladujBaze);
</script>
</body>
</html>
